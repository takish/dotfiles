#!/bin/bash
# Merge mcpServers from chezmoi into existing ~/.claude.json
# This preserves all runtime stats while syncing MCP configuration

set -e

# Read from target file (chezmoi processes templates before running modify scripts)
MCP_CONFIG="$HOME/.claude.json.mcpServers"

# Read current file from stdin
current=$(cat)

if [[ -f "$MCP_CONFIG" ]]; then
    mcp_servers=$(cat "$MCP_CONFIG")
    # Use -j to suppress trailing newline (Claude Code saves without trailing newline)
    echo "$current" | jq -j --argjson mcp "$mcp_servers" '.mcpServers = $mcp'
else
    # Remove trailing newline to match Claude Code's format
    printf '%s' "$current"
fi
